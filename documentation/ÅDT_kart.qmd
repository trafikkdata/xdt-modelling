---
title: "ÅDT kart"
format:
  html:
    embed-resources: true
execute: 
  warning: false
  echo: false
  root.dir: !expr here::here()
---

**Hva viser kartene?**
Kartene viser estimatene fra den gamle modellen, som ble brukt til ÅDT-belegginga for 2024, og "prototype"-estimat fra den nye modellen, til å bruke på denne workshopen. Begge modellene baserer seg på data fra 2024. Merk at estimatene fra den nye modellen ikke er endelige, og vil endre seg ettersom vi gjør nye forbedringer.


**Kartforklaring**

- Trafikklenker med *svart omriss* er steder hvor vi har data fra trafikkregistreringspunkt eller andre kilder.
- *Fargen* på trafikklenkene indikerer ÅDT-verdien: gul tilsvarer de laveste verdiene, og lilla tilsvarer de høyeste verdiene. 
- Kartene viser *retta* trafikklenker.


```{r}
#| message: false
#| echo: false
#| warning: false
#| include: false
# Plott til fagsamling 26.-27. november 2025

# Load functions
files.sources <- list.files(here::here("R/"), full.names = TRUE)
sapply(files.sources, function(x) source(x))

# Load packages
library(sf)
library(tidyverse)

data <- readRDS(here::here("data/processed/engineered_data.rds"))
aadt2024 <- read.csv(here::here("data/raw/traffic-links-aadt-data-2024.csv"))
model_res <- readRDS(here::here("results/latest_model.rds"))
```


```{r}
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
# Gjør originale estimater retta ----
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# Count how many directed links each undirected link has
directed_counts <- data |>
  group_by(parentTrafficLinkId) |>
  summarise(n_directed = n(), .groups = "drop")

# Join the counts to the 2024 predictions
aadt2024_with_counts <- aadt2024 |>
  left_join(directed_counts, by = c("ID" = "parentTrafficLinkId"))

# Split the AADT values based on number of directed links
aadt2024_directed <- data |>
  select(id, parentTrafficLinkId, aadt, county, municipalityIds) |>
  left_join(aadt2024_with_counts, by = c("parentTrafficLinkId" = "ID")) |>
  mutate(
    ÅDT.Estimert = as.numeric(ÅDT.Estimert),
    ÅDT.Estimert.Directed = case_when(
      n_directed == 1 ~ ÅDT.Estimert,        # One-way: full volume
      n_directed == 2 ~ ÅDT.Estimert / 2,    # Bidirectional: split in half
      TRUE ~ NA_real_                         # Handle unexpected cases
    )
  ) |>
  select(id, parentTrafficLinkId, ÅDT.Estimert.Directed, aadt, county, municipalityIds) %>% 
  add_geometry_to_traffic_links()

aadt2024_directed$balanced_pred <- round(aadt2024_directed[["ÅDT.Estimert.Directed"]])

```

```{r}
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
# Side-by-side map setup ----
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

library(leaflet)
library(leaflet.extras2)
library(sf)


plot_comparison <- function(old_preds, new_preds, selected_county = NULL, selected_municipality = NULL){
  
  # Check that exactly one filter is provided
  if(is.null(selected_county) && is.null(selected_municipality)) {
    stop("Must provide either 'selected_county' or 'selected_municipality'")
  }
  if(!is.null(selected_county) && !is.null(selected_municipality)) {
    stop("Provide only one of 'selected_county' or 'selected_municipality', not both")
  }
  
  # Apply filter based on which argument was provided
  if(!is.null(selected_county)) {
    roads_old <- old_preds %>% 
      filter(county == !!selected_county)
    roads_new <- new_preds %>% 
      filter(county == !!selected_county)
  } else {
    roads_old <- old_preds %>% 
      filter(municipalityIds == !!selected_municipality)
    roads_new <- new_preds %>% 
      filter(municipalityIds == !!selected_municipality)
  }
  
  # Prepare your data (filter to area of interest first!)
  roads_old <- roads_old %>% 
    mutate(aadt_version = "Gammel modell")

  roads_new <- roads_new %>% 
    mutate(aadt_version = "Ny modell") %>% 
    add_geometry_to_traffic_links()
  
  # Create color palette (use same scale for both!)
  aadt_range <- range(c(roads_old$balanced_pred, roads_new$balanced_pred), na.rm = TRUE)
  pal <- colorNumeric("viridis", domain = aadt_range, reverse = TRUE)
  
  nvdb <- nvdb_objects()
  
  # Build map
  m <- leaflet(options = leaflet::leafletOptions(crs = nvdb$nvdb_crs, zoomControl = FALSE)) %>%
    addMapPane("old", zIndex = 0) %>%
    addMapPane("new", zIndex = 0) %>% 
    
    # Add base tiles to BOTH groups
    addTiles(urlTemplate = nvdb$nvdb_url, 
             attribution = nvdb$nvdb_attribution,
             group = "old", layerId = "oldid",
             options = pathOptions(pane = "old")) %>%
    addTiles(urlTemplate = nvdb$nvdb_url, 
             attribution = nvdb$nvdb_attribution,
             group = "new", layerId = "newid",
             options = pathOptions(pane = "new")) %>%
    
    addPolylines(
      data = roads_old %>% filter(!is.na(aadt)),
      color = "black",  # or "white" depending on contrast
      weight = 9,  # Slightly thicker than main line
      opacity = 1,
      group = "old",
      options = pathOptions(pane = "old")
    ) %>% 
    addPolylines(
      data = roads_old %>% filter(!is.na(aadt)),
      color = "black",  # or "white" depending on contrast
      weight = 9,  # Slightly thicker than main line
      opacity = 1,
      group = "old",
      options = pathOptions(pane = "new")
    ) %>% 
    
    # Old predictions (left side)
    addPolylines(
      data = roads_old,
      color = ~pal(balanced_pred),
      weight = 4.5,
      opacity = 0.9,
      group = "old",
      options = pathOptions(pane = "old"),
      popup = ~ifelse(
        !is.na(aadt),
        sprintf("Gammel modell: %s ÅDT | Registrert: %s ÅDT <br> ID: %s", 
                scales::comma(balanced_pred), 
                scales::comma(aadt),
                id),
        sprintf("Gammel modell: %s ÅDT <br> ID: %s", scales::comma(balanced_pred), id)
      )
    ) %>%
    
    # New predictions (right side)
    addPolylines(
      data = roads_new,
      color = ~pal(balanced_pred),
      weight = 4.5,
      opacity = 0.9,
      group = "new",
      options = pathOptions(pane = "new"),
      popup = ~ifelse(
        !is.na(aadt),
        sprintf("Prototype-modell: %s ÅDT | Registrert: %s ÅDT <br> ID: %s", 
                scales::comma(balanced_pred), 
                scales::comma(aadt),
                id),
        sprintf("Prototype-modell: %s  ÅDT <br> ID: %s", scales::comma(balanced_pred), id)
      )
    ) %>%
    
    # Add the side-by-side control
    addSidebyside(
      layerId = "sidecontrols",
      leftId = "oldid",
      rightId = "newid"
    ) %>%
    # Add title for left side
    addControl(
      html = "<div style='background: rgba(255,255,255,0.8); padding: 10px; border-radius: 5px; font-weight: bold; font-size: 16px;'>Gammel ÅDT-modell</div>",
      position = "topleft"
    ) %>%
    
    # Add title for right side
    addControl(
      html = "<div style='background: rgba(255,255,255,0.8); padding: 10px; border-radius: 5px; font-weight: bold; font-size: 16px;'>Prototype-modell</div>",
      position = "topright"
    ) %>%
    
    # Shared legend
    addLegend(
      pal = pal,
      values = aadt_range,
      title = "ÅDT",
      position = "bottomright",
      labFormat = labelFormat(big.mark = " ")
    )
  
  return(m)
}


```



### Stavanger

```{r}
plot_comparison(aadt2024_directed, model_res$data, selected_municipality = "1103")
```

### Trondheim

```{r}
plot_comparison(aadt2024_directed, model_res$data, selected_municipality = "5001")
```

