---
title: "Demonstrasjon: ÅDT-modell med fjorårets ÅDT"
format: html
execute: 
  warning: false
  echo: false
  root.dir: !expr here::here()
---


```{r}
#| echo: false
#| include: false

# Load functions
files.sources = list.files("../R/", full.names = TRUE)
sapply(files.sources, source)

# Load packages
library(sf)
library(tidyverse)
library(tictoc)

# Data
data <- readRDS("../data/processed/engineered_data.rds")
aadt2024 <- read.csv("../data/raw/traffic-links-aadt-data-2024.csv")
nodes <- readRDS("../data/processed/nodes.RDS")
adjacency_matrix <- readRDS("../data/processed/adjacency_matrix_2024.rds")
```


## Endinger i ÅDT fra 2023 til 2024

```{r}
library(dplyr)
library(ggplot2)
library(leaflet)
library(tidyr)

aadt2024 <- aadt2024 %>% 
  mutate(ÅDT.2023 = as.numeric(ÅDT.fjorårets),
         ÅDT.2024 = as.numeric(ÅDT.offisiell),
         data.2023 = if_else(Datagrunnlag == "CONTINUOUS_REGISTRATION", ÅDT.2023, NA),
         data.2024 = if_else(Datagrunnlag == "CONTINUOUS_REGISTRATION", ÅDT.2024, NA),
         pred.2023 = if_else(Datagrunnlag == "CONTINUOUS_REGISTRATION", NA, ÅDT.2023),
         pred.2024 = if_else(Datagrunnlag == "CONTINUOUS_REGISTRATION", NA, ÅDT.2024)
         ) %>% 
  add_county(county_number_col = "Fylkesnr")
```


```{r}
# Prepare data in long format for plotting
aadt_long <- aadt2024 |>
  select(ÅDT.2023, ÅDT.2024, pred.2023, pred.2024, data.2023, data.2024) |>
  pivot_longer(
    everything(),
    names_to = c("type", "year"),
    names_pattern = "(.+)\\.(\\d{4})",
    values_to = "aadt"
  ) |>
  mutate(
    type = case_when(
      type == "ÅDT" ~ "ÅDT",
      type == "pred" ~ "Estimert",
      type == "data" ~ "Registrert"
    )
  )

aadt_plot <- filter(aadt_long, type %in% c("Registrert", "Estimert"))

# Scatter plot

# For predicted data
pred_scatter <- aadt2024 |>
  select(pred.2023, pred.2024, Vegkategori, county_name) |>
  mutate(type = "Estimert")

# For measured data  
data_scatter <- aadt2024 |>
  select(data.2023, data.2024, Vegkategori, county_name) |>
  rename(pred.2023 = data.2023, pred.2024 = data.2024) |>
  mutate(type = "Registrert")

# Combine them
scatter_data <- bind_rows(pred_scatter, data_scatter)
```


```{r}
# Now plot
ggplot(scatter_data, aes(x = pred.2024 + 1, y = pred.2023 + 1)) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "darkred") +
  geom_point(alpha = 0.3) +
  scale_x_log10(labels = scales::comma) +
  scale_y_log10(labels = scales::comma) +
  coord_equal() +
  facet_wrap(~type) +
  labs(
    title = "ÅDT 2023 vs 2024",
    x = "ÅDT 2024",
    y = "ÅDT 2023",
    subtitle = "Punkter på diagonal-linja indikerer samme verdi for de to årene."
  ) +
  theme_minimal()

scatter_data %>% filter(Vegkategori == "F") %>% 
  ggplot(aes(x = pred.2024 + 1, y = pred.2023 + 1, color = type)) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "darkred") +
  geom_point(alpha = 0.3) +
  scale_x_log10(labels = scales::comma) +
  scale_y_log10(labels = scales::comma) +
  scale_color_manual(values = c("goldenrod", "grey10")) +
  coord_equal() +
  facet_wrap(~county_name) +
  labs(
    title = "ÅDT 2023 vs 2024",
    x = "ÅDT 2024",
    y = "ÅDT 2023",
    subtitle = "Punkter på diagonal-linja indikerer samme verdi for de to årene."
  ) +
  theme_minimal()
```


## Tilpass modell med og uten fjorårets ÅDT som forklaringsvariabel

```{r}
#| echo: false
#| eval: false


data <- data |> 
  mutate(log_last_year_aadt = case_when(
    is.na(lastYearAadt_trafficVolumeValue) ~ log(median(lastYearAadt_trafficVolumeValue, na.rm = TRUE) + 1),
    TRUE ~ log(lastYearAadt_trafficVolumeValue + 1)
  ))

#data$log_last_year_aadt2 <- log(data$lastYearAadt_trafficVolumeValue + 1)

clusters <- strategic_network_clustering(data)

covariates <- c("functionalRoadClass:maxLanes",
                "minLanes:roadCategory",
                "functionalRoadClass",
                "functionalRoadClass:isRamp",
                "maxLanes",
                "roadCategory",
                "hasOnlyPublicTransportLanes")
covariates_with_last_year <- c("functionalRoadClass:maxLanes",
                "minLanes:roadCategory",
                "functionalRoadClass",
                "functionalRoadClass:isRamp",
                "maxLanes",
                "roadCategory",
                "hasOnlyPublicTransportLanes",
                "log_last_year_aadt")


model <- run_modeling_pipeline(
  data = data,
  nodes = nodes,
  aadt2024 = aadt2024,
  adjacency_matrix = adjacency_matrix,
  balancing_grouping_variable = clusters,
  covariates = covariates,
  nodes_to_balance = "complete_nodes",
  model_name = "without last year"
)

model_with_last_year <- run_modeling_pipeline(
  data = data,
  nodes = nodes,
  aadt2024 = aadt2024,
  adjacency_matrix = adjacency_matrix,
  balancing_grouping_variable = clusters,
  covariates = covariates_with_last_year,
  nodes_to_balance = "complete_nodes",
  model_name = "with last year"
)

model_with_only_last_year <- run_modeling_pipeline(
  data = data,
  nodes = nodes,
  aadt2024 = aadt2024,
  adjacency_matrix = adjacency_matrix,
  balancing_grouping_variable = clusters,
  covariates = "log_last_year_aadt",
  nodes_to_balance = "complete_nodes",
  model_name = "with last year"
)

saveRDS(list(model = model, 
             model_with_last_year = model_with_last_year,
             model_with_only_last_year = model_with_only_last_year), 
        "../results/with_and_wo_last_year.RDS")
```

```{r}
models <- readRDS("../results/with_and_wo_last_year.RDS")
model <- models$model
model_with_last_year <- models$model_with_last_year
model_with_only_last_year <- models$model_with_only_last_year

print_approval_summary(models)
```

```{r}
library(patchwork)

plot_predictions_and_data <- function(model_data){
  # Scatter plot of undirected predictions versus last year's AADT
  ggplot(arrange(model_data$diagnostics$approval$undirected_data, desc(Datagrunnlag)), 
       aes(x = as.numeric(ÅDT.offisiell) + 1, y = pred +1, 
           color = Datagrunnlag == "CONTINUOUS_REGISTRATION")) +
  geom_point(alpha = 0.5) +
  scale_color_manual(values = c("grey10", "#e10531")) +
  scale_x_log10(labels = scales::comma, breaks = c(10, 100, 1000, 10000, 100000)) +
  scale_y_log10(labels = scales::comma, breaks = c(10, 100, 1000, 10000, 100000)) +
  coord_equal() +
  labs(
    title = "ÅDT 2024 vs estimert ÅDT fra ny modell",
    x = "ÅDT 2024",
    y = "Estimert ÅDT fra ny modell",
    subtitle = "Punkter på diagonal-linja indikerer enighet."
  ) +
  theme_minimal() +
  theme(legend.position = "none")
}

p1 <- plot_predictions_and_data(model)
p2 <- plot_predictions_and_data(model_with_last_year)

p1 + p2

```

```{r}
ggplot(arrange(model_with_last_year$diagnostics$approval$undirected_data, desc(eale)), 
       aes(x = as.numeric(ÅDT.offisiell) + 1, y = pred +1, 
           color = eale > 1)) +
  geom_point(alpha = 0.5) +
  scale_color_manual(values = c("grey10", "#e10531")) +
  #scale_x_log10(labels = scales::comma, breaks = c(10, 100, 1000, 10000, 100000)) +
  #scale_y_log10(labels = scales::comma, breaks = c(10, 100, 1000, 10000, 100000)) +
  coord_equal() +
  labs(
    title = "ÅDT 2024 vs estimert ÅDT fra ny modell",
    x = "ÅDT 2024",
    y = "Estimert ÅDT fra ny modell",
    subtitle = "Punkter på diagonal-linja indikerer enighet."
  ) +
  theme_minimal() +
  theme(legend.position = "none")

extremes <- filter(model_with_last_year$diagnostics$approval$undirected_data, eale > 1)

measured_extremes <- filter(extremes, Datagrunnlag == "CONTINUOUS_REGISTRATION")
```

Her er det noen datakilder som har blitt korrigert. Jeg tror mange av de er på grunn av at registrert data har blitt overstyrt manuelt, men modellen bruker ikke-overstyrt data.


Lag et separat plott som viser den retta dataen, og hvor prediksjonene har korrigert de ulike datakildene.

```{r}
ggplot(model_with_last_year$data, 
       aes(x = aadt + 1, y = balanced_pred + 1, color = traffic_volume_source)) +
  geom_point(alpha = 0.7) +
  scale_x_log10(labels = scales::comma, breaks = c(10, 100, 1000, 10000, 100000)) +
  scale_y_log10(labels = scales::comma, breaks = c(10, 100, 1000, 10000, 100000)) +
  coord_equal() +
    labs(
    title = "Modellens overstyring av ÅDT fra datakilde",
    x = "ÅDT fra datakilde",
    y = "ÅDT fra modellen",
    subtitle = "Punkter på diagonal-linja indikerer enighet."
  ) +
  theme_minimal()

overwritten_data <- filter(model_with_last_year$data, 
                           exp(abs(log(aadt) - log(balanced_pred))) - 1 > 0.2 &
                             abs(aadt - balanced_pred > 10)) %>% 
  select(id, county, lastYearAadt_trafficVolumeValue, aadt, aadt_sd, traffic_volume_source, traffic_volume_year, balanced_pred) %>% 
  mutate(balanced_pred = round(balanced_pred))
```


```{r}
plot_directed_links(overwritten_data, balanced = TRUE, county = NULL)
```

```{r}
plot_directed_links(model_with_last_year$data, county_to_plot = "Oslo")

```

